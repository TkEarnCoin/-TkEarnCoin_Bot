<!-- 
=====================================================================
====== অ্যাড নেটওয়ার্কের SDK বসানোর জায়গা (প্রথম অংশ) ======
=====================================================================
এখানে আপনার পছন্দের অ্যাড নেটওয়ার্কের দেওয়া <script> ট্যাগটি বসাতে হবে।
নিচের লাইনটি একটি উদাহরণ মাত্র। আপনি এটিকে পরিবর্তন করে আপনার নিজের কোড বসাবেন।
-->

<!-- ✅ Ad SDK Integration (Updated) -->
<script src='//libtl.com/sdk.js' data-zone='10168595' data-sdk='show_10168595'></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    const userData = tg.initDataUnsafe.user;
    const defaultProfilePic40 = 'https://via.placeholder.com/40';
    const defaultProfilePic80 = 'https://via.placeholder.com/80';

    const navItems = document.querySelectorAll('.nav-item');
    const pages = document.querySelectorAll('.page');
    const watchAdBtn = document.getElementById('watch-ad-btn');
    const startEarningBtn = document.getElementById('start-earning-btn');
    const withdrawBtn = document.getElementById('withdraw-btn');
    const withdrawForm = document.getElementById('withdraw-form');

    const DAILY_ADS_LIMIT = 50;
    const AD_REWARD = 0.02; // BDT per ad
    const MIN_WITHDRAW_AMOUNT = 100;

    if (!localStorage.getItem('earnings')) {
        localStorage.setItem('earnings', '0');
        localStorage.setItem('adsWatched', '0');
        localStorage.setItem('totalReferrals', '0');
    }

    function updateUI() {
        const earnings = parseFloat(localStorage.getItem('earnings'));
        const adsWatched = parseInt(localStorage.getItem('adsWatched'));
        const referrals = parseInt(localStorage.getItem('totalReferrals'));

        const formattedEarnings = earnings.toFixed(2);

        if(userData) {
            const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();
            document.getElementById('header-user-name').textContent = fullName || 'User';
            document.getElementById('profile-user-name').textContent = fullName || 'User';
            document.getElementById('profile-user-username').textContent = userData.username ? `@${userData.username}` : 'No username';
            
            if (userData.photo_url) {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const proxiedPhotoUrl = `${proxyUrl}${encodeURIComponent(userData.photo_url)}`;
                document.getElementById('header-profile-pic').src = proxiedPhotoUrl;
                document.getElementById('profile-page-pic').src = proxiedPhotoUrl;
            } else {
                document.getElementById('header-profile-pic').src = defaultProfilePic40;
                document.getElementById('profile-page-pic').src = defaultProfilePic80;
            }
        }

        document.getElementById('current-balance').textContent = `BDT ${formattedEarnings}`;
        document.getElementById('total-earnings').textContent = `BDT ${formattedEarnings}`;
        document.getElementById('ads-watched').textContent = adsWatched;
        document.getElementById('total-referrals').textContent = referrals;

        document.getElementById('ad-progress-text').textContent = `Completed: ${adsWatched} / ${DAILY_ADS_LIMIT}`;
        const progress = (adsWatched / DAILY_ADS_LIMIT) * 100;
        document.getElementById('ad-progress-bar').style.width = `${progress}%`;

        watchAdBtn.disabled = adsWatched >= DAILY_ADS_LIMIT;
        watchAdBtn.querySelector('span').textContent = adsWatched >= DAILY_ADS_LIMIT ? 'cancel' : 'play_circle_filled';
        if(adsWatched >= DAILY_ADS_LIMIT) watchAdBtn.childNodes[0].nodeValue = "দৈনিক সীমা পৌঁছে গেছে ";

        document.getElementById('withdraw-balance-display').textContent = `BDT ${formattedEarnings}`;
        document.getElementById('submit-withdraw-btn').disabled = earnings < MIN_WITHDRAW_AMOUNT;
        if(earnings < MIN_WITHDRAW_AMOUNT) document.getElementById('submit-withdraw-btn').textContent = `ন্যূনতম BDT ${MIN_WITHDRAW_AMOUNT} প্রয়োজন`;

        document.getElementById('profile-balance').textContent = `BDT ${formattedEarnings}`;
        document.getElementById('profile-earnings').textContent = `BDT ${formattedEarnings}`;
        document.getElementById('profile-ads-watched').textContent = adsWatched;
        document.getElementById('profile-referrals').textContent = referrals;
    }

    function showPage(targetPageId) {
        navItems.forEach(nav => nav.classList.remove('active'));
        pages.forEach(page => page.classList.remove('active'));

        const activeNavItem = document.querySelector(`[data-page="${targetPageId}"]`);
        if (activeNavItem) activeNavItem.classList.add('active');
        
        const activePage = document.getElementById(targetPageId);
        if (activePage) activePage.classList.add('active');
    }

    navItems.forEach(item => {
        item.addEventListener('click', () => showPage(item.getAttribute('data-page')));
    });

    startEarningBtn.addEventListener('click', () => showPage('earn-page'));
    withdrawBtn.addEventListener('click', () => showPage('withdraw-page'));
    
    // ✅ Updated Ad Network SDK Call
    watchAdBtn.addEventListener('click', () => {
        if (parseInt(localStorage.getItem('adsWatched')) >= DAILY_ADS_LIMIT) {
            tg.showAlert('আপনার দৈনিক বিজ্ঞাপনের সীমা পৌঁছে গেছে।');
            return;
        }

        watchAdBtn.disabled = true;

        if (typeof show_10168595 === 'function') {
            show_10168595('pop').then(() => {
                let earnings = parseFloat(localStorage.getItem('earnings')) + AD_REWARD;
                let currentAdsWatched = parseInt(localStorage.getItem('adsWatched')) + 1;
                
                localStorage.setItem('earnings', earnings.toString());
                localStorage.setItem('adsWatched', currentAdsWatched.toString());
                
                tg.showAlert(`বিজ্ঞাপনটি দেখার জন্য আপনি BDT ${AD_REWARD.toFixed(2)} পেয়েছেন!`);
            }).catch(() => {
                tg.showAlert('বিজ্ঞাপনটি দেখাতে সমস্যা হয়েছে। আবার চেষ্টা করুন।');
            }).finally(() => {
                updateUI();
            });
        } else {
            let earnings = parseFloat(localStorage.getItem('earnings')) + AD_REWARD;
            let currentAdsWatched = parseInt(localStorage.getItem('adsWatched')) + 1;
            localStorage.setItem('earnings', earnings.toString());
            localStorage.setItem('adsWatched', currentAdsWatched.toString());
            alert(`(Test Mode) You earned BDT ${AD_REWARD.toFixed(2)}!`);
            updateUI();
        }
    });

    withdrawForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        
        tg.showConfirm(`আপনি কি আপনার উইথড্র অনুরোধ জমা দিতে চান?`, (confirmed) => {
            if (confirmed) {
                let newEarnings = parseFloat(localStorage.getItem('earnings')) - amount;
                localStorage.setItem('earnings', newEarnings.toString());
                
                tg.sendData(JSON.stringify({ 
                    type: 'withdrawal', 
                    amount: amount, 
                    method: document.getElementById('withdraw-method').value,
                    account: document.getElementById('account-number').value
                }));
                
                withdrawForm.reset();
                updateUI();
                tg.showAlert('আপনার উইথড্র অনুরোধ সফলভাবে জমা হয়েছে।');
            }
        });
    });

    updateUI();
});
</script>
</body>
</html>
